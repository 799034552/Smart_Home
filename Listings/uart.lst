C51 COMPILER V9.60.0.0   UART                                                              07/05/2021 18:54:41 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\Objects\uart.obj
COMPILER INVOKED BY: D:\work\keilc51\C51\BIN\C51.EXE User\uart.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\User) DEBUG PRIN
                    -T(.\Listings\uart.lst) TABS(2) OBJECT(.\Objects\uart.obj)

line level    source

   1          #include "uart.h"
   2          #include <stdio.h>
   3          //串口数据
   4          unsigned char i2 = 0;
   5          bit Busy = 0;
   6          xdata char uart2SendData[100];
   7          xdata char strRes[8] = "10\011111";
   8          //串口2初始化
   9          void uart2Init(void)
  10          {
  11   1        S2CON = 0x50;             //方式1，八位数据，可变波特率
  12   1        AUXR1 = 0x00;          //1T工作方式
  13   1        PCON  = 0x00;          //不倍增波特率
  14   1        IP2   = 0x00;          //优先级默认
  15   1        BRT   = 0XFD;            //设置波特率9600
  16   1        AUXR  = 0x10;          //启动波特率发生器
  17   1        EA    = 1;           //开总中断
  18   1        IP   = 0x00;         //优先级默认
  19   1        IE2   = 0x01;          //开串口2中断
  20   1      }
  21          unsigned char ES2(char b) {if(b==-1) return IE2&0x01;b?(IE2|=0x01):(IE2&=~0x01);return 1;}
  22          unsigned char S2RI(char b) {if(b==-1) return S2CON&0x01;b?(S2CON|=0x01):(S2CON&=~0x01);return 1;}
  23          unsigned char S2TI(char b) {if(b==-1) return S2CON&0x02;b?(S2CON|=0x02):(S2CON&=~0x02);return 1;}
  24          void uart2AddChar(char* s)
  25          {
  26   1        uchar i = 0;
  27   1        uchar len = 0;
  28   1        while(s[len++] != '\0');
  29   1        for(i = 0; i< len-1; i++)
  30   1        {
  31   2          uart2SendData[i2++] = s[i];
  32   2        }
  33   1      }
  34          void uart2AddCharLen(char* s, uchar len)
  35          {
  36   1        uchar i = 0;
  37   1        for(i = 0; i< len; i++)
  38   1        {
  39   2          uart2SendData[i2++] = s[i];
  40   2        }
  41   1      }
  42          void uart2Clear() {i2=0;}
  43          
  44          void uart2Send()
  45          {
  46   1        unsigned char i = 0;
  47   1        ES2(0);
  48   1        for(i = 0; i < i2; i++)
  49   1        {
  50   2          S2BUF = uart2SendData[i];
  51   2          while(!S2TI(-1));
  52   2          S2TI(0);
  53   2        }
  54   1        ES2(1);
C51 COMPILER V9.60.0.0   UART                                                              07/05/2021 18:54:41 PAGE 2   

  55   1        uart2Clear();
  56   1      }
  57          void uart2SendEnd()
  58          {
  59   1        uart2AddChar("\r\n");
  60   1        uart2Send();
  61   1      }
  62          void uart2SendChar(char*s)
  63          {
  64   1        uart2Clear();
  65   1        uart2AddChar(s);
  66   1        uart2SendEnd();
  67   1      }
  68          void uartInit(void)
  69          {
  70   1        TMOD|=0x20;
  71   1        TH1=0xfd;
  72   1        TL1=0xfd;
  73   1        TR1=1;
  74   1        REN=1;
  75   1        SM0=0;
  76   1        SM1=1;
  77   1        EA=1;
  78   1        ES=1;
  79   1      }
  80          void uartSend(char*s)
  81          {
  82   1        uchar i;
  83   1        uchar len = 0;
  84   1        while(s[len++] != '\0');
  85   1        len-=1;
  86   1      //  ES = 0;
  87   1        for(i = 0; i < len;i++)
  88   1        {
  89   2          SBUF = s[i];
  90   2          while(!TI);
  91   2          TI = 0;
  92   2        }
  93   1      //  ES = 1;
  94   1      }
  95          void uartSend_number(long num)
  96          {
  97   1        char i;
  98   1        uchar nums[12];
  99   1        uchar len = 0;
 100   1        while(num / 10)
 101   1        {
 102   2          nums[len++] = num % 10;
 103   2          num /= 10;
 104   2        }
 105   1        nums[len++] = num % 10;
 106   1        ES = 0;
 107   1        for(i = len - 1; i >= 0;i--)
 108   1        {
 109   2          SBUF = nums[i] + '0';
 110   2          while(!TI);
 111   2          TI = 0;
 112   2        }
 113   1        ES = 1;
 114   1      }
 115          bit strInclude(uchar*s1,uchar*s2,char len1, char len2)
 116          {
C51 COMPILER V9.60.0.0   UART                                                              07/05/2021 18:54:41 PAGE 3   

 117   1        uchar i = 0,j = 0;
 118   1        if (len1 < len2)
 119   1          return 0;
 120   1        for(i = 0; i <= len1 - len2; i++)
 121   1        {
 122   2          for(j=0; j < len2; j++)
 123   2          {
 124   3            if(s1[i+j] != s2[j])
 125   3              break;
 126   3          }
 127   2          if(j == len2)
 128   2            return 1;
 129   2        }
 130   1        return 0;
 131   1      }
 132          /*********************
 133                转换函数
 134          **********************/
 135          char* num_to_Str(long num, char want_bit)
 136          {
 137   1        uchar i;
 138   1        long t = 1;
 139   1        if(want_bit == -1)
 140   1        {
 141   2          want_bit = 1;
 142   2          while(num / t != 0)
 143   2          {
 144   3            want_bit++;
 145   3            t *=10;
 146   3          }
 147   2      
 148   2        }else
 149   1        {
 150   2          for(i=0; i < want_bit ;i++)
 151   2            t*=10;
 152   2          num %= t;
 153   2        }
 154   1        i = 0;
 155   1        t /= 10;
 156   1        while(t != 0)
 157   1        {
 158   2          strRes[i++] = num / t + '0';
 159   2          num %= t;
 160   2          t /= 10;
 161   2        }
 162   1        strRes[i] = '\0';
 163   1        return strRes;
 164   1      }
 165          ///*************************************************
 166          //                    串口屏是否忙
 167          //*************************************************/
 168          void checkBusy()
 169          {
 170   1        Busy = 1;
 171   1        while(Busy);
 172   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1021    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =    108    ----
C51 COMPILER V9.60.0.0   UART                                                              07/05/2021 18:54:41 PAGE 4   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1      46
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
